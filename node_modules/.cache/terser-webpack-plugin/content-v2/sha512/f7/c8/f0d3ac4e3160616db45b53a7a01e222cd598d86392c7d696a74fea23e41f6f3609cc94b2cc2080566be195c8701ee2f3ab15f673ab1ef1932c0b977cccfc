{"code":"module.exports=function(t){var e={};function s(r){if(e[r])return e[r].exports;var n=e[r]={i:r,l:!1,exports:{}};return t[r].call(n.exports,n,n.exports,s),n.l=!0,n.exports}return s.m=t,s.c=e,s.d=function(t,e,r){s.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:r})},s.r=function(t){\"undefined\"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:\"Module\"}),Object.defineProperty(t,\"__esModule\",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&\"object\"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(s.r(r),Object.defineProperty(r,\"default\",{enumerable:!0,value:t}),2&e&&\"string\"!=typeof t)for(var n in t)s.d(r,n,function(e){return t[e]}.bind(null,n));return r},s.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return s.d(e,\"a\",e),e},s.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},s.p=\"\",s(s.s=13)}([function(t,e,s){\"use strict\";Object.defineProperty(e,\"__esModule\",{value:!0});const r={MONGO_URL:\"mongodb://localhost/goosendr-dev\",JWT_SECRET:process.env.SECRET||\"Aditek\"},n={MONGO_URL:\"mongodb://localhost/goosendr-test\",JWT_SECRET:process.env.SECRET||\"Aditek\"},i={MONGO_URL:\"mongodb://localhost/goosendr-prod\",JWT_SECRET:process.env.SECRET||\"Aditek\"},a={PORT:process.env.PORT||3e3};e.default={...a,...function(t){switch(t){case\"development\":return r;case\"test\":return n;default:return i}}(\"production\")}},function(t,e){t.exports=require(\"mongoose\")},function(t,e){t.exports=require(\"express\")},function(t,e,s){\"use strict\";const r=s(4),n=s(30),i=s(12).Strategy,a=s(12).ExtractJwt,o=s(6),u=s(0),c={jwtFromRequest:a.fromAuthHeaderAsBearerToken(),secretOrKey:u.JWT_SECRET},d=new n({usernameField:\"email\"},async(t,e,s)=>{try{const r=await o.fetchOne({email:t});return r&&r.authenticateUser(e)?s(null,r):s(null,!1)}catch(t){return s(t,!1)}}),p=new i(c,async(t,e)=>{try{const s=await o.fetchOne({_id:t._id});return e(null,s?s:!1)}catch(t){return e(t,!1)}});r.use(d),r.use(p);const l=r.authenticate(\"local\",{session:!1}),f=r.authenticate(\"jwt\",{session:!1});t.exports={authLocal:l,authJwt:f}},function(t,e){t.exports=require(\"passport\")},function(t,e){t.exports=require(\"express-validation\")},function(t,e,s){\"use strict\";const r=s(7),n=s(28)().get_ip;e.save=(async t=>{try{const e=new r(t);return await e.save()}catch(t){throw Error(t)}}),e.fetch=(async(t,e,s)=>{try{return await r.paginate(t,{page:e,limit:s,sort:{_id:\"asc\"}})}catch(t){throw Error(\"Error while paginating admins\")}}),e.fetchOne=(async t=>{try{return await r.findOne(t)}catch(t){throw Error(\"Error fetching admin\")}}),e.update=(async(t,e)=>{try{return await r.updateOne(t,{$set:e})}catch(t){throw Error(\"Error editing admin\")}}),e.delete=(async t=>{try{return await r.deleteOne(t)}catch(t){throw Error(\"Error deleting admin\")}}),e.getIP=(t=>{return n(t).clientIp})},function(t,e,s){\"use strict\";const r=s(1),n=s(23),i=s(24),a=s(8),o=s(25),u=s(0),c=s(9),d=new r.Schema({_id:{type:r.Schema.Types.ObjectId,required:!0},name:{type:String,required:[!0,\"Name is required!\"],trim:!0},email:{type:String,unique:!0,required:[!0,\"Email is required!\"],trim:!0,validate:{validator:t=>n.isEmail(t),message:\"{VALUE} is not a valid email!\"}},password:{type:String,required:[!0,\"Password is required!\"],trim:!0,minlength:[4,\"Password need to be longer!\"]},favorites:{posts:[{type:r.Schema.Types.ObjectId,ref:\"Post\"}]},type:{type:String,required:[!0,\"Admin Type is required!\"],trim:!0},ip:{type:String,required:!0,trim:!0},signup:{type:Date,default:Date.now},lastlogin:{type:Date,default:Date.now},notescheck:{type:Date,default:Date.now},loggedIn:{type:Boolean,default:!1},avatar:{},token:{type:String,required:!1,trim:!0},loginType:{type:String,default:\"admin\"},expire:{type:String,required:!1,trim:!0}});d.pre(\"save\",function(t){return this.isModified(\"password\")&&(this.password=this._hashPassword(this.password)),t()}),d.methods={_hashPassword:t=>a.hashSync(t),authenticateUser(t){return a.compareSync(t,this.password)},createToken(){return o.sign({_id:this._id},u.JWT_SECRET)},toAuthJSON(){return{_id:this._id,name:this.name,email:this.email,password:this.password,type:this.type,ip:this.ip,signup:this.signup,lastlogin:this.lastlogin,avatar:this.avatar,token:`bearer ${this.createToken()}`}},toJSON(){return{_id:this._id,name:this.name,email:this.email,avatar:this.avatar}},_favorites:{async posts(t){return this.favorites.posts.indexOf(t)>=0?(this.favorites.posts.remove(t),await c.decFavoriteCount(t)):(this.favorites.posts.push(t),await c.incFavoriteCount(t)),this.save()},isPostIsFavorite(t){return this.favorites.posts.indexOf(t)>=0}}},d.plugin(i),t.exports=r.model(\"Admin\",d)},function(t,e){t.exports=require(\"bcrypt-nodejs\")},function(t,e,s){\"use strict\";const r=s(1),n=s(26),i=s(27),a=r.Schema({title:{type:String,trim:!0,required:[!0,\"Title is required!\"],minlength:[3,\"Title need to be longer!\"],unique:!0},text:{type:String,trim:!0,required:[!0,\"Text is required!\"],minlength:[10,\"Text need to be longer!\"]},slug:{type:String,trim:!0,lowercase:!0},user:{type:r.Schema.Types.ObjectId,ref:\"Admin\"},favoriteCount:{type:Number,default:0}},{timestamps:!0});a.plugin(i,{message:\"{VALUE} already taken!\"}),a.pre(\"validate\",function(t){this._slugify(),t()}),a.methods={_slugify(){this.slug=n(this.title)},toJSON(){return{_id:this._id,title:this.title,text:this.text,createdAt:this.createdAt,slug:this.slug,user:this.user,favoriteCount:this.favoriteCount}}},a.statics={createPost(t,e){return this.create({...t,user:e})},list({skip:t=0,limit:e=5}={}){return this.find().sort({createdAt:-1}).skip(t).limit(e).populate(\"user\")},incFavoriteCount(t){return this.findByIdAndUpdate(t,{$inc:{favoriteCount:1}})},decFavoriteCount(t){return this.findByIdAndUpdate(t,{$inc:{favoriteCount:-1}})}},t.exports=r.model(\"Post\",a)},function(t,e){t.exports=require(\"http-status\")},function(t,e){t.exports=require(\"joi\")},function(t,e){t.exports=require(\"passport-jwt\")},function(t,e,s){\"use strict\";var r=o(s(2)),n=o(s(0));s(14);var i=o(s(15)),a=o(s(20));function o(t){return t&&t.__esModule?t:{default:t}}const u=(0,r.default)();(0,i.default)(u),u.get(\"/\",(t,e)=>{e.send(\"Hello world!\")}),(0,a.default)(u),u.listen(n.default.PORT,t=>{if(t)throw t;console.log(`Server running on port: ${n.default.PORT}\\n    -- - Running on production`)})},function(t,e,s){\"use strict\";var r=i(s(1)),n=i(s(0));function i(t){return t&&t.__esModule?t:{default:t}}r.default.Promise=global.Promise;try{r.default.connect(n.default.MONGO_URL)}catch(t){r.default.createConnection(n.default.MONGO_URL)}r.default.connection.once(\"open\",()=>console.log(\"MongoDB Running\")).on(\"error\",t=>{throw t})},function(t,e,s){\"use strict\";s(16);const r=s(17),n=s(18),i=s(19),a=s(4);t.exports=(t=>{t.use(n()),t.use(i()),t.use(r.json()),t.use(r.urlencoded({extended:!0})),t.use(a.initialize())})},function(t,e){t.exports=require(\"morgan\")},function(t,e){t.exports=require(\"body-parser\")},function(t,e){t.exports=require(\"compression\")},function(t,e){t.exports=require(\"helmet\")},function(t,e,s){\"use strict\";const r=s(21),n=s(31),{authJwt:i}=s(3);t.exports=(t=>{t.use(\"/api/v1/admin\",r),t.use(\"/api/v1/posts\",n),t.get(\"/hello\",i,(t,e)=>{e.send(\"This is a private route!!!!\")})})},function(t,e,s){\"use strict\";const r=s(2),n=s(5),i=s(22),a=r.Router(),o=s(29),{authLocal:u}=s(3);a.post(\"/register\",n(o.register),i.save),a.post(\"/login\",u,i.login),t.exports=a},function(t,e,s){\"use strict\";const r=s(6),n=s(1),i=s(8),a=s(10);e.save=(async(t,e)=>{(async()=>{const s=t.body;s._id=new n.Types.ObjectId,s.ip=r.getIP(t),s.loginType=\"admin\";try{const t=await r.save(s);return e.status(a.CREATED).json(t.toAuthJSON())}catch(t){return e.status(a.BAD_REQUEST).json(t)}})().then()}),e.fetch=(async(t,e)=>{const s=t.params.page?parseInt(t.params.page,10):1,n=t.params.limit?parseInt(t.params.limit,10):10;try{const t=await r.fetch({},s,n);return e.status(a.OK).json(t)}catch(t){return e.status(a.BAD_REQUEST).json(t)}}),e.fetchOne=(async(t,e)=>{try{const s=await r.fetchOne({_id:t.params.id});return e.status(a.OK).json(s)}catch(t){return e.status(a.BAD_REQUEST).json(t)}}),e.login=((t,e,s)=>{const n=t.user;n.lastlogin=new Date,n.ip=r.getIP(t),n.loginType=\"admin\",n.loggedIn=!0,(async n=>{try{return await r.update({_id:n._id},n,{multi:!1})?(e.status(a.OK).json(t.user.toAuthJSON()),s()):(e.status(a.BAD_REQUEST).json({message:\"Unknown  error occurred!\"}),s())}catch(t){return e.status(a.BAD_REQUEST).json(t),s()}})(n).then()}),e.update=(async(t,e)=>{const s={name:t.body.name,email:t.body.email,type:t.body.type,avatar:t.body.avatar};try{const n=await r.update({_id:t.params.id},s);return e.status(a.OK).json(n)}catch(t){return e.status(a.BAD_REQUEST).json(t)}}),e.editPassword=(async(t,e)=>{if(\"\"===t.body.pass1||\"\"===t.body.pass2||\"\"===t.body.password)return e.status(a.BAD_REQUEST).json({message:\"Please fill out all fields\"});if(t.body.pass1!==t.body.pass2)return e.status(a.BAD_REQUEST).json({message:\"Passwords do not match\"});let s=async s=>{try{const n=await r.update({_id:t.params.id},{password:s},{multi:!1});return e.status(a.OK).json(n)}catch(t){return e.status(a.BAD_REQUEST).json(t)}};try{const n=await r.fetchOne({_id:t.params.id});if(!n)return e.status(a.BAD_REQUEST).json({message:\"You're not eligible to change the password\"});if(!i.compareSync(t.body.password,n.password))return e.status(a.BAD_REQUEST).json({message:\"Invalid old password\"});(async()=>{i.hash(t.body.pass1,null,null,(t,e)=>{s(e).then()})})().then()}catch(t){return e.status(a.BAD_REQUEST).json(t)}}),e.delete=(async(t,e)=>{try{const s=await r.delete({_id:t.params.id});return e.status(a.OK).json(s)}catch(t){return e.status(a.BAD_REQUEST).json(t)}})},function(t,e){t.exports=require(\"validator\")},function(t,e){t.exports=require(\"mongoose-paginate\")},function(t,e){t.exports=require(\"jsonwebtoken\")},function(t,e){t.exports=require(\"slug\")},function(t,e){t.exports=require(\"mongoose-unique-validator\")},function(t,e){t.exports=require(\"ipware\")},function(t,e,s){\"use strict\";const r=s(11);t.exports={register:{body:{email:r.string().email().required(),password:r.string().regex(/(?=.*\\d)(?=.*[a-z])(?=.*[A-Z]).{6,}/).required(),type:r.string().required(),name:r.string().required()}}}},function(t,e){t.exports=require(\"passport-local\")},function(t,e,s){\"use strict\";const r=s(2),n=s(5),i=s(32),a=r.Router(),o=s(33),{authJwt:u}=s(3);a.post(\"/\",u,n(o.createPost),i.createPost),a.get(\"/:id\",u,i.getPostById),a.get(\"/\",u,i.getPostsList),a.patch(\"/:id\",u,n(o.updatePost),i.updatePost),a.delete(\"/:id\",u,i.deletePost),a.post(\"/:id/favorite\",u,i.favoritePost),t.exports=a},function(t,e,s){\"use strict\";const r=s(9),n=s(10),i=s(7);e.createPost=(async(t,e)=>{try{const s=await r.createPost(t.body,t.user._id);return e.status(n.CREATED).json(s)}catch(t){return e.status(n.BAD_REQUEST).json(t)}}),e.getPostById=(async(t,e)=>{try{const s=await Promise.all([i.findById(t.user._id),r.findById(t.params.id).populate(\"user\")]),a=s[0]._favorites.isPostIsFavorite(t.params.id),o=s[1];return e.status(n.OK).json({...o.toJSON(),favorite:a})}catch(t){return e.status(n.BAD_REQUEST).json(t)}}),e.getPostsList=(async(t,e)=>{const s=parseInt(t.query.limit,0),a=parseInt(t.query.skip,0);try{const o=await Promise.all([i.findById(t.user._id),r.list({limit:s,skip:a})]),u=o[1].reduce((t,e)=>{const s=o[0]._favorites.isPostIsFavorite(e._id);return t.push({...e.toJSON(),favorite:s}),t},[]);return e.status(n.OK).json(u)}catch(t){return e.status(n.BAD_REQUEST).json(t)}}),e.updatePost=(async(t,e)=>{try{const s=await r.findById(t.params.id);return s.user.equals(t.user._id)?(Object.keys(t.body).forEach(e=>{s[e]=t.body[e]}),e.status(n.OK).json(await s.save())):e.sendStatus(n.UNAUTHORIZED)}catch(t){return e.status(n.BAD_REQUEST).json(t)}}),e.deletePost=(async(t,e)=>{try{const s=await r.findById(t.params.id);return s.user.equals(t.user._id)?(await s.remove(),e.sendStatus(n.OK)):e.sendStatus(n.UNAUTHORIZED)}catch(t){return e.status(n.BAD_REQUEST).json(t)}}),e.favoritePost=(async(t,e)=>{try{const s=await i.findById(t.user._id);return await s._favorites.posts(t.params.id),e.sendStatus(n.OK)}catch(t){return e.status(n.BAD_REQUEST).json(t)}})},function(t,e,s){\"use strict\";const r=s(11);t.exports={createPost:{body:{title:r.string().min(3).required(),text:r.string().min(10).required()}},updatePost:{body:{title:r.string().min(3),text:r.string().min(10)}}}}]);","extractedComments":[]}